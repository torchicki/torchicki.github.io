<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>あわログ Blog</title>
        <link>https://awaro.click/blog</link>
        <description>あわログ Blog</description>
        <lastBuildDate>Sun, 18 Feb 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ja</language>
        <item>
            <title><![CDATA[NGINXとLet‘s Encryptを利用したHTTPSサーバの構築]]></title>
            <link>https://awaro.click/blog/https-web-server</link>
            <guid>https://awaro.click/blog/https-web-server</guid>
            <pubDate>Sun, 18 Feb 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[NGINXにLet's Encryptで取得したサーバ証明書を適用し、HTTPSサーバを建てるための手順]]></description>
            <content:encoded><![CDATA[<p>NGINXにLet's Encryptで取得したサーバ証明書を適用し、HTTPSサーバを建てるための手順</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="必要なツールの準備">必要なツールの準備<a href="https://awaro.click/blog/https-web-server#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E6%BA%96%E5%82%99" class="hash-link" aria-label="必要なツールの準備 への直接リンク" title="必要なツールの準備 への直接リンク">​</a></h2>
<p>NGINXとLet's Encryptを利用した署名所作成ツール（certbot）のインストールを行う。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginxのインストール">NGINXのインストール<a href="https://awaro.click/blog/https-web-server#nginx%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" class="hash-link" aria-label="NGINXのインストール への直接リンク" title="NGINXのインストール への直接リンク">​</a></h3>
<p><code>yum install nginx</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certbotのインストール">certbotのインストール<a href="https://awaro.click/blog/https-web-server#certbot%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" class="hash-link" aria-label="certbotのインストール への直接リンク" title="certbotのインストール への直接リンク">​</a></h3>
<p><code>yum install certbot</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="証明書の取得">証明書の取得<a href="https://awaro.click/blog/https-web-server#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E5%8F%96%E5%BE%97" class="hash-link" aria-label="証明書の取得 への直接リンク" title="証明書の取得 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="証明書の取得コマンド">証明書の取得コマンド<a href="https://awaro.click/blog/https-web-server#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E5%8F%96%E5%BE%97%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89" class="hash-link" aria-label="証明書の取得コマンド への直接リンク" title="証明書の取得コマン�ド への直接リンク">​</a></h3>
<p>証明書の取得をcertbotコマンドを利用して行う。<br>
<!-- -->このコマンドは80番ポートでLet's Encrypt からの通信を待ち受け、必要な通信を行う。<br>
<code>certbot certonly --standalone -d &lt;ドメイン名&gt; -m &lt;メールアドレス&gt; --agree-tos -n</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="サーバのhttps化">サーバのHTTPS化<a href="https://awaro.click/blog/https-web-server#%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AEhttps%E5%8C%96" class="hash-link" aria-label="サーバのHTTPS化 への直接リンク" title="サーバのHTTPS化 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginxの設定">NGINXの設定<a href="https://awaro.click/blog/https-web-server#nginx%E3%81%AE%E8%A8%AD%E5%AE%9A" class="hash-link" aria-label="NGINXの設定 への直接リンク" title="NGINXの設定 への直接リンク">​</a></h3>
<p>NGINXにSSL設定と証明書鍵のファイルパスを記載する。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..&lt;中略&gt;..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       443 ssl http2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       [::]:443 ssl http2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate "/etc/letsencrypt/live/&lt;Domain名&gt;/fullchain.pem";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key "/etc/letsencrypt/live/&lt;Domain名&gt;/privkey.pem";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..&lt;中略&gt;..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上記設定後にNGINXを再起動し設定を反映する。<br>
<code>systemctl restart nginx</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="証明書の更新">証明書の更新<a href="https://awaro.click/blog/https-web-server#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E6%9B%B4%E6%96%B0" class="hash-link" aria-label="証明書の更新 への直接リンク" title="証明書の更新 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="証明書更新のための設定変更">証明書更新のための設定変更<a href="https://awaro.click/blog/https-web-server#%E8%A8%BC%E6%98%8E%E6%9B%B8%E6%9B%B4%E6%96%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4" class="hash-link" aria-label="証明書更新のための設定変更 への直接リンク" title="証明書更新のための設定変更 への直接リンク">​</a></h3>
<p>Let's Encryptで取得した証明書の期間は90日と短いため、定期的に更新する必要がある。<br>
<!-- -->しかし、80番ポートに関しては既にNGINXで利用しているため、取得時と同様にcertbotが80番ポートを利用することができない。<br>
<!-- -->そのため、Let's Encryptの証明書更新に必要なファイルはHTTPでアクセスできる用にNGINXの設定ファイルを変更する。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       [::]:80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location ^~/.well-known/acme-challenge/ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_type "text/plain";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 301 https://$host$request_uri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>それに合わせて、Let's Encryptの設定を変更する。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Options used in the renewal process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[renewalparams]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authenticator = webroot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webroot_path = /usr/share/nginx/html,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[webroot_map]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;domain名&gt; = /usr/share/nginx/html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>疎通確認のため、以下のコマンドを実行しエラーが発生しないか確認する。<br>
<code>certbot renew --dry-run</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="証明書更新の自動化">証明書更新の自動化<a href="https://awaro.click/blog/https-web-server#%E8%A8%BC%E6%98%8E%E6%9B%B8%E6%9B%B4%E6%96%B0%E3%81%AE%E8%87%AA%E5%8B%95%E5%8C%96" class="hash-link" aria-label="証明書更新の自動化 への直接リンク" title="証明書更新の自動化 への直接リンク">​</a></h3>
<p>月に一回anacronを利用して更新を行うようにする。<br>
<code>yum install cronie-anacron</code><br>
<code>systemctl enable anacron</code><br>
<code>vi /etc/cron.monthly/letsencrypt.sh</code></p>
<div class="language-shell:letsencrypt.sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell:letsencrypt.sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certbot renew &gt; /dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>[参考サイト]</p>
<ul>
<li><a href="https://qiita.com/HeRo/items/f9eb8d8a08d4d5b63ee9" target="_blank" rel="noopener noreferrer">Let's Encrypt で Nginx にSSLを設定する</a></li>
</ul>]]></content:encoded>
            <category>Linux</category>
            <category>nginx</category>
            <category>letsencrypt</category>
        </item>
        <item>
            <title><![CDATA[logrotateの処理順の検証]]></title>
            <link>https://awaro.click/blog/logrotate</link>
            <guid>https://awaro.click/blog/logrotate</guid>
            <pubDate>Sun, 26 Jan 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[logrotateの設定として、ファイルの圧縮やScriptを実行するオプションがありますが、]]></description>
            <content:encoded><![CDATA[<p>logrotateの設定として、ファイルの圧縮やScriptを実行するオプションがありますが、<br>
<!-- -->どのタイミングで圧縮やローテーション、Scriptが実行されるかを理解せずに書いていたことで、<br>
<!-- -->スクリプトが想定通りに実行されないことがあったため、処理順について検証しました。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="検証用設定ファイルの作成">検証用設定ファイルの作成<a href="https://awaro.click/blog/logrotate#%E6%A4%9C%E8%A8%BC%E7%94%A8%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90" class="hash-link" aria-label="検証用設定ファイルの作成 への直接リンク" title="検証用設定ファイルの作成 への直接リンク">​</a></h2>
<p>まず、以下のようなlogrotate設定ファイルを作成する。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/root/rotate/test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weekly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rotate 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ifempty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    missingok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sharedscripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "firstaction" &gt; /root/rotate/script_order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls /root/rotate/test* &gt; /root/rotate/firstaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endscript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prerotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "prerotate" &gt;&gt; /root/rotate/script_order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls /root/rotate/test* &gt; /root/rotate/prerotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endscript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postrotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "postrotate" &gt;&gt; /root/rotate/script_order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls /root/rotate/test* &gt; /root/rotate/postrotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endscript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preremove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "preremove" &gt;&gt; /root/rotate/script_order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls /root/rotate/test* &gt; /root/rotate/preremove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endscript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "firstaction" &gt; /root/rotate/script_order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls /root/rotate/test* &gt; /root/rotate/lastaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endscript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logrotateの実行">logrotateの実行<a href="https://awaro.click/blog/logrotate#logrotate%E3%81%AE%E5%AE%9F%E8%A1%8C" class="hash-link" aria-label="logrotateの実行 への直接リンク" title="logrotateの実行 への直接リンク">​</a></h2>
<p>touchなどでローテーション対象のファイルを作成して、1回ローテーションを実行する。<br>
<!-- -->script_orderを確認して処理順を確認したところ、logrotateに設定したScriptは以下の順で事項される</p>
<ol>
<li>firstaction</li>
<li>prerotate</li>
<li>postrotate</li>
<li>preremove</li>
<li>lastaction</li>
</ol>
<p>次に、logrotateを実行したときのローテーションなどの処理順を確認するために、<br>
<!-- -->さらに2回ローテーションを実行する。<br>
<!-- -->(rotate 2 のため合計3回のローテーション処理実行をする)</p>
<p>各ファイルの中身は以下のようになった。</p>
<ul>
<li>
<p>script_order</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firstaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prerotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postrotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preremove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preremove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lastaction</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>firstaction</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.1.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.2.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>prerotate</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.2.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.3.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>postrotate</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.2.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.3.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>preremove</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.1.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.2.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.3.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>lastaction</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.1.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.2.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>1回目と違い、preremoveが二回実行されていたが、どうやらファイルを削除する直前に毎回呼び出される模様。<br>
<!-- -->(preremove -&gt; test.1を削除 -&gt; preremove -&gt; test.3.gzを削除)</p>
<p>ローテーション対象ファイルが複数ある場合は以下のように実行された。<br>
<!-- -->(preremove -&gt; test.1を削除 -&gt; preremove -&gt; test.3.gzを削除<br>
<!-- -->-&gt; preremove -&gt; sample.1を削除 -&gt; preremove -&gt; sample.3.gzを削除)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logrotate設定の動作順">logrotate設定の動作順<a href="https://awaro.click/blog/logrotate#logrotate%E8%A8%AD%E5%AE%9A%E3%81%AE%E5%8B%95%E4%BD%9C%E9%A0%86" class="hash-link" aria-label="logrotate設定の動作順 への直接リンク" title="logrotate設定の動作順 への直接リンク">​</a></h2>
<p>したがって、各ファイルの実行結果から、logrotateの実行順序は</p>
<ol>
<li>firstaction/endscriptの実行</li>
<li>ローテーション済みファイルのローテーション(例：test.1.gz-&gt;test.2.gz)</li>
<li>prerotate/endscriptの実行</li>
<li>対象ファイルのローテーション(例：test-&gt;test.1)</li>
<li>postrotate/endscriptの実行</li>
<li>ファイルの圧縮(例：test.1-&gt;test.1.gz)</li>
<li>preremove/endscriptの実行※</li>
<li>圧縮元ファイルの削除(例：test.1の削除)※</li>
<li>preremove/endscriptの実行※</li>
<li>期限切れファイルの削除(例：test.3.gzの削除)※</li>
<li>lastaction/endscriptの実行</li>
</ol>
<p>※preremoveはローテーション対象ファイル数回、繰り返し実行される。</p>]]></content:encoded>
            <category>Linux</category>
            <category>logrotate</category>
        </item>
    </channel>
</rss>